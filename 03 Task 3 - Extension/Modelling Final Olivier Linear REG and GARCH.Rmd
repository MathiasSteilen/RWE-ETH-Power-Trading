---
title: "Statslab Modelling Olivier"
author: "Olivier Zehnder"
date: "2024-05-01"
output: html_document
---

--> Try just cutting prices at 1 and then log to see what happens
--> try using the inverse sign hyperbolic function on the response (arsinh and back transform sinh, maybe need to check sfsmisc package)
--> Errors should not accumulate in models...
--> Ad a title page, but not so important
--> In Report go very much in detail and put out everything we have tried
--> Have appendices with all the R code and plots which we tried and put it into a long appendix (tables, graphics, etc.)
--> e.g. 15 pages report and like 30 pages appendix
--> use .^2 in formulas to include all 2 ways interactoins, but only if you have a penalization term, so not in unpenalized models
--> look at how to tune the Garch models to avoid to specific convergence etc.
--> also look at different transformation of response and then see if solving convergence issues like that
--> e.g. stop model when accuracy is 3 digits instead of 6 digits
--> Also put into the reports the models which did not work, and detail why it is not working, what error messages we got etc.
--> Put all of your code onto the Github
--> Differentiate between the realistic frame and no
--> check out forecast package regarding on how to do the predictions (tito's file)
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Loading libraries / Defining functions
```{r}
### Modelling of Swiss Day ahead prices

# Load necessary libraries

library(rugarch)
library(forecast)
library(dplyr)

#Functions
# Define a function to calculate R-squared
calculate_r_squared <- function(true_values, fitted_values) {
  # Calculate the mean of true values
  true_mean <- mean(true_values)
  
  # Calculate total sum of squares (TSS)
  TSS <- sum((true_values - true_mean)^2)
  
  # Calculate residual sum of squares (RSS)
  RSS <- sum((true_values - fitted_values)^2)
  
  # Calculate R-squared
  R_squared <- 1 - (RSS / TSS)
  
  return(R_squared)
}
# Load your dataset

```

Loading data:
```{r}
df_CH_DA <- read.csv("~/Downloads/0_df_theoretical_ch_spot_price.csv", header=TRUE)
df_CH_DA$date <- as.Date(df_CH_DA$date)
df_CH_DA$cal_day_in_month = as.factor(df_CH_DA$cal_day_in_month)
df_CH_DA$cal_day_in_week = as.factor(df_CH_DA$cal_day_in_week)
df_CH_DA$cal_hour_in_day= as.factor(df_CH_DA$cal_hour_in_day)
df_CH_DA$cal_month = as.factor(df_CH_DA$cal_month)
df_CH_DA$cal_quarter = as.factor(df_CH_DA$cal_quarter)


df_DE_DA <- read.csv("~/Downloads/0_df_theoretical_chde_auction_price.csv", header=TRUE)
df_DE_DA$date <- as.Date(df_DE_DA$date)
df_DE_DA$cal_day_in_month = as.factor(df_DE_DA$cal_day_in_month)
df_DE_DA$cal_day_in_week = as.factor(df_DE_DA$cal_day_in_week)
df_DE_DA$cal_hour_in_day= as.factor(df_DE_DA$cal_hour_in_day)
df_DE_DA$cal_month = as.factor(df_DE_DA$cal_month)
df_DE_DA$cal_quarter = as.factor(df_DE_DA$cal_quarter)

df_DE_CH_AUCT <-read.csv("~/Downloads/0_df_theoretical_dech_auction_price.csv", header=TRUE)
df_DE_CH_AUCT$date <- as.Date(df_DE_CH_AUCT$date)
df_DE_CH_AUCT$cal_day_in_month = as.factor(df_DE_CH_AUCT$cal_day_in_month)
df_DE_CH_AUCT$cal_day_in_week = as.factor(df_DE_CH_AUCT$cal_day_in_week)
df_DE_CH_AUCT$cal_hour_in_day= as.factor(df_DE_CH_AUCT$cal_hour_in_day)
df_DE_CH_AUCT$cal_month = as.factor(df_DE_CH_AUCT$cal_month)
df_DE_CH_AUCT$cal_quarter = as.factor(df_DE_CH_AUCT$cal_quarter)

df_CH_DE_AUCT <- read.csv("~/Downloads/0_df_theoretical_chde_auction_price.csv", header=TRUE)
df_CH_DE_AUCT$date <- as.Date(df_CH_DE_AUCT$date)
df_CH_DE_AUCT$cal_day_in_month = as.factor(df_CH_DE_AUCT$cal_day_in_month)
df_CH_DE_AUCT$cal_day_in_week = as.factor(df_CH_DE_AUCT$cal_day_in_week)
df_CH_DE_AUCT$cal_hour_in_day= as.factor(df_CH_DE_AUCT$cal_hour_in_day)
df_CH_DE_AUCT$cal_month = as.factor(df_CH_DE_AUCT$cal_month)
df_CH_DE_AUCT$cal_quarter = as.factor(df_CH_DE_AUCT$cal_quarter)

```

Getting rid of linear dependent cols:
```{r}
df_CH_DA_train= arrange(df_CH_DA, date)[1:8734,]
fit_cleaning= lm(day_ahead_price_ch~., data=df_CH_DA_train)

# Identify predictors with NA coefficients (indicating rank deficiency)
na_predictors <- names(fit_cleaning$coefficients)[is.na(fit_cleaning$coefficients)]

df_CH_DA <- df_CH_DA %>%
  select(-any_of(na_predictors))

df_DE_DA <- df_DE_DA %>%
  select(-any_of(na_predictors))

df_DE_CH_AUCT <- df_DE_CH_AUCT %>%
  select(-any_of(na_predictors))

df_CH_DE_AUCT <- df_CH_DE_AUCT %>%
  select(-any_of(na_predictors))
```



Split the data into training and testing data. Training data is data from the year 2023, testing data from the year 2024
```{r}


df_CH_DA_train= arrange(df_CH_DA, date)[1:8734,] #Split data at end of 2023 / Beginning of 2024  into train and test
df_CH_DA_test= arrange(df_CH_DA, date)[8735:9477,]

df_DE_DA_train= arrange(df_DE_DA, date)[1:8734,]
df_DE_DA_test= arrange(df_DE_DA, date)[8735:9477,]

df_DE_CH_AUCT_train= arrange(df_DE_CH_AUCT, date)[1:8734,]
df_DE_CH_AUCT_test= arrange(df_DE_CH_AUCT, date)[8735:9477,]

df_CH_DE_AUCT_train= arrange(df_CH_DE_AUCT, date)[1:8734,]
df_CH_DE_AUCT_test= arrange(df_CH_DE_AUCT, date)[8735:9477,]

rm(df_CH_DA)
rm(df_DE_DA)
rm(df_DE_CH_AUCT)
rm(df_CH_DE_AUCT)
```



##Part One##: Baseline Model, Linear Regression

As a baseline, we fit a linear regression to see how well it will perform

```{r}
### PART ONE: BASELINE MODEL - Linear Regression 
fit_DA_CH= lm(day_ahead_price_ch~., data=df_CH_DA_train)
fit_DA_DE= lm(day_ahead_price_de~., data=df_DE_DA_train)
fit_AC_DE_CH= lm(auction_price_de_ch~., data=df_DE_CH_AUCT_train)
fit_AC_CH_DE= lm(auction_price_ch_de~., data=df_CH_DE_AUCT_train)

#Visualization of fit:
plot(df_CH_DA_train$day_ahead_price_ch, type="l", main="fit_DA_CH")
lines(fit_DA_CH$fitted.values, col="red")

plot(df_DE_DA_train$day_ahead_price_de, type="l", main="fit_DA_DE")
lines(fit_DA_DE$fitted.values, col="red")

plot(df_DE_CH_AUCT_train$auction_price_de_ch, type="l", main="fit_AC_DE_CH")
lines(fit_AC_DE_CH$fitted.values, col="red")

plot(df_CH_DE_AUCT_train$auction_price_ch_de, type="l", main="fit_AC_CH_DE")
lines(fit_AC_CH_DE$fitted.values, col="red")

```

###Resiudal Analysis:###
```{r}
# Plotting the residuals
residuals_DA_price_ch  <- residuals(fit_DA_CH)
residuals_DA_price_de  <- residuals(fit_DA_DE)
residuals_auct_CH_DE<- residuals(fit_AC_CH_DE)
residuals_auct_DE_CH <- residuals(fit_AC_DE_CH)


# Plot histogram of residuals
hist(residuals_auct_DE_CH, breaks = 20, main = "Histogram of Residuals")
hist(residuals_auct_CH_DE, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_ch, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_de, breaks = 20, main = "Histogram of Residuals")

# Plot QQ plot of residuals
qqnorm(residuals_auct_DE_CH)
qqline(residuals_auct_DE_CH)

qqnorm(residuals_auct_CH_DE)
qqline(residuals_auct_CH_DE)

qqnorm(residuals_DA_price_ch)
qqline(residuals_DA_price_ch)

qqnorm(residuals_DA_price_de)
qqline(residuals_DA_price_de)
```

```{r}
#removing last 24 rows due to shifted data

#First Insights: Every fit seems to be decent, except for the Auction price from 
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743], predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,]))
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,]))^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,]))
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,]))^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,])))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,])))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,])))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,])))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE, Auction_Price_DE_CH )

# Print the result
print(result_table)
```

```{r}
#Visualization of out of samplefit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(-100,200))
lines(predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="fit_DA_DE",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(-50,250))
lines(predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim=c(-50,100))
lines(pmax(0,predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n",, ylim=c(0,40) )
lines(pmax(0,predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```

Model overfits trianing data strongly, what about only using date and financial data for prediciton:
```{r}
### PART ONE: BASELINE MODEL - Linear Regression 
fit_DA_CH= lm(day_ahead_price_ch~., data=df_CH_DA_train[,c(1:9, 22:26)])
fit_DA_DE= lm(day_ahead_price_de~., data=df_DE_DA_train[,c(1:9, 22:26)])
fit_AC_DE_CH= lm(auction_price_de_ch~., data=df_DE_CH_AUCT_train[,c(1:9, 22:26)])
fit_AC_CH_DE= lm(auction_price_ch_de~., data=df_CH_DE_AUCT_train[,c(1:9, 22:26)])

#Visualization of fit:
plot(df_CH_DA_train$day_ahead_price_ch, type="l", main="fit_DA_CH")
lines(fit_DA_CH$fitted.values, col="red")

plot(df_DE_DA_train$day_ahead_price_de, type="l", main="fit_DA_DE")
lines(fit_DA_DE$fitted.values, col="red")

plot(df_DE_CH_AUCT_train$auction_price_de_ch, type="l", main="fit_AC_DE_CH")
lines(fit_AC_DE_CH$fitted.values, col="red")

plot(df_CH_DE_AUCT_train$auction_price_ch_de, type="l", main="fit_AC_CH_DE")
lines(fit_AC_CH_DE$fitted.values, col="red")

```

###Resiudal Analysis:###
```{r}
# Plotting the residuals
residuals_DA_price_ch  <- residuals(fit_DA_CH)
residuals_DA_price_de  <- residuals(fit_DA_DE)
residuals_auct_CH_DE<- residuals(fit_AC_CH_DE)
residuals_auct_DE_CH <- residuals(fit_AC_DE_CH)


# Plot histogram of residuals
hist(residuals_auct_DE_CH, breaks = 20, main = "Histogram of Residuals")
hist(residuals_auct_CH_DE, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_ch, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_de, breaks = 20, main = "Histogram of Residuals")

# Plot QQ plot of residuals
qqnorm(residuals_auct_DE_CH)
qqline(residuals_auct_DE_CH)

qqnorm(residuals_auct_CH_DE)
qqline(residuals_auct_CH_DE)

qqnorm(residuals_DA_price_ch)
qqline(residuals_DA_price_ch)

qqnorm(residuals_DA_price_de)
qqline(residuals_DA_price_de)
```

```{r}
#removing last 24 rows due to shifted data

#First Insights: Every fit seems to be decent, except for the Auction price from 
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743], predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,]))
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,]))^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,]))
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,]))^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,])))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,])))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,])))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,])))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE, Auction_Price_DE_CH )

# Print the result
print(result_table)
```
Works great for German day ahead prices


```{r}
#Visualization of out of samplefit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(-100,200))
lines(predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="fit_DA_DE",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(-50,250))
lines(predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim=c(-50,100))
lines(pmax(0,predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n",, ylim=c(0,15) )
lines(pmax(0,predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```

Models overfit extermely, lets see what we get with selecting the variables taking into account all interaction effects
######## RUN OVERNIGHT ######
```{r}

# Backward Selection for day_ahead_price_ch
fit_DA_CH_backward <- step(fit_DA_CH, direction = "backward",  scope = formula(fit_DA_CH) ~ . * .)
#fit_DA_CH_forward<- step(fit_DA_CH, direction = "forward", , scope = formula(fit_DA_CH) ~ . * .)
#fit_DA_CH_extensive <- step(fit_DA_CH, direction = "extensive")

# Backward Selection for day_ahead_price_de
fit_DA_DE_backward <- step(fit_DA_DE, direction = "backward", scope = formula(fit_DA_DE) ~ . * .)

#fit_DA_DE_forward <- step(fit_DA_DE, direction = "forward", scope = formula(fit_DA_DE) ~ . * .)
#fit_DA_DE_extensive <- step(fit_DA_DE, direction = "extensive")

# Backward Selection for auction_price_de_ch
fit_AC_DE_CH_backward <- step(fit_AC_DE_CH, direction = "backward", scope = formula(fit_AC_DE_CH) ~ . * .)
#fit_AC_DE_CH_forward <- step(fit_AC_DE_CH, direction = "forward", scope = formula(fit_AC_DE_CH) ~ . * .)
#fit_AC_DE_CH_extensive <- step(fit_AC_DE_CH, direction = "extensive")

# Backward Selection for auction_price_ch_de
fit_AC_CH_DE_backward <- step(fit_AC_CH_DE, direction = "backward", scope = formula(fit_AC_CH_DE) ~ . * .)
#fit_AC_CH_DE_forward <- step(fit_AC_CH_DE, direction = "forward", scope = formula(fit_AC_CH_DE) ~ . * .)
#fit_AC_CH_DE_extensive <- step(fit_AC_CH_DE, direction = "extensive")

```

```{r}
# Save forward selection models
save(fit_DA_CH_forward, fit_DA_DE_forward, fit_AC_DE_CH_forward, fit_AC_CH_DE_forward, 
     file = "forward_selection_models_AIC.RData")

# Save backward selection models
save(fit_DA_CH_backward, fit_DA_DE_backward, fit_AC_DE_CH_backward, fit_AC_CH_DE_backward, 
     file = "backward_selection_models_AIC.RData")

```


```{r}
#Visualization of fit of backwards selection:
plot(df_CH_DA_train$day_ahead_price_ch, type="l", main="fit_DA_CH BACKWARD")
lines(fit_DA_CH_backward$fitted.values, col="red")
#plot(df_CH_DA_train$day_ahead_price_ch, type="l", main="fit_DA_CH Forward")
#lines(fit_DA_CH_forward$fitted.values, col="red")

plot(df_DE_DA_train$day_ahead_price_de, type="l", main="fit_DA_DE BACKWARD")
lines(fit_DA_DE_backward$fitted.values, col="red")
#plot(df_DE_DA_train$day_ahead_price_de, type="l", main="fit_DA_DE Forward")
#lines(fit_DA_DE_forward$fitted.values, col="red")

plot(df_DE_CH_AUCT_train$auction_price_de_ch, type="l", main="fit_AC_DE_CH BACKWARD")
lines(fit_AC_DE_CH_backward$fitted.values, col="red")
#plot(df_DE_CH_AUCT_train$auction_price_de_ch, type="l", main="fit_AC_DE_CH Forward")
#lines(fit_AC_DE_CH_forward$fitted.values, col="red")

plot(df_CH_DE_AUCT_train$auction_price_ch_de, type="l", main="fit_AC_CH_DE BACKWARD")
lines(fit_AC_CH_DE_backward$fitted.values, col="red")
#plot(df_CH_DE_AUCT_train$auction_price_ch_de, type="l", main="fit_AC_CH_DE Forward")
#lines(fit_AC_CH_DE_forward$fitted.values, col="red")

```

###Resiudal Analysis:###
```{r}
# Plotting the residuals
residuals_DA_price_ch_backward  <- residuals(fit_DA_CH_backward)
residuals_DA_price_de_backward  <- residuals(fit_DA_DE_backward)
residuals_auct_CH_DE_backward<- residuals(fit_AC_CH_DE_backward)
residuals_auct_DE_CH_backward <- residuals(fit_AC_DE_CH_backward)


#residuals_DA_price_ch_forward  <- residuals(fit_DA_CH_forward)
#residuals_DA_price_de_forward  <- residuals(fit_DA_DE_forward)
#residuals_auct_CH_DE_forward<- residuals(fit_AC_CH_DE_forward)
#residuals_auct_DE_CH_forward <- residuals(fit_AC_DE_CH_forward)


# Plot histogram of residuals
hist(residuals_DA_price_ch_backward, breaks = 20, main = "Histogram of residuals_DA_price_ch_backward")
hist(residuals_DA_price_de_backward, breaks = 20, main = "Histogram of residuals_DA_price_de_backward")
hist(residuals_auct_CH_DE_backward, breaks = 20, main = "Histogram of residuals_auct_CH_DE_backward")
hist(residuals_auct_DE_CH_backward, breaks = 20, main = "Histogram of residuals_auct_DE_CH_backward")


# Plot histogram of residuals
#hist(residuals_DA_price_ch_forward, breaks = 20, main = "Histogram of residuals_DA_price_ch_forward")
#hist(residuals_DA_price_de_forward, breaks = 20, main = "Histogram of residuals_DA_price_de_forward")
#hist(residuals_auct_CH_DE_forward, breaks = 20, main = "Histogram of residuals_auct_CH_DE_forward")
#hist(residuals_auct_DE_CH_forward, breaks = 20, main = "Histogram of Residuals_auct_DE_CH_forward")

# Plot QQ plot of residuals
qqnorm(residuals_DA_price_ch_backward, main="residuals_DA_price_ch_backward")
qqline(residuals_DA_price_ch_backward)

qqnorm(residuals_DA_price_de_backward, main="residuals_DA_price_de_backward")
qqline(residuals_DA_price_de_backward)

qqnorm(residuals_auct_CH_DE_backward, main="residuals_auct_CH_DE_backward")
qqline(residuals_auct_CH_DE_backward)

qqnorm(residuals_auct_DE_CH_backward, main= "residuals_auct_DE_CH_backward")
qqline(residuals_auct_DE_CH_backward)

#qqnorm(residuals_DA_price_ch_forward, main="residuals_DA_price_ch_forward")
#qqline(residuals_DA_price_ch_forward)

#qqnorm(residuals_DA_price_de_forward,  main= "residuals_DA_price_de_forward")
#qqline(residuals_DA_price_de_forward)

#qqnorm(residuals_auct_CH_DE_forward, main="residuals_auct_CH_DE_forward")
#qqline(residuals_auct_CH_DE_forward)

#qqnorm(residuals_auct_DE_CH_forward, main="residuals_auct_DE_CH_forward")
#qqline(residuals_auct_DE_CH_forward)


```



```{r}
#Visualization of out of samplefit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions (Backwards)",  xlab = " ", ylab = "Price", xaxt = "n")
lines(predict(object = fit_DA_CH_backward, newdata = df_CH_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="German Day Ahead Prices - Predictions (Backwards)",  xlab = " ", ylab = "Price", xaxt = "n")
lines(predict(object = fit_DA_DE_backward, newdata = df_DE_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="Auction Prices DE-CH - Predictions (Backward)", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,predict(object = fit_AC_DE_CH_backward, newdata = df_DE_CH_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="Auction Prices CH-DE - Predictions (Backward)", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,predict(object = fit_AC_CH_DE_backward, newdata = df_CH_DE_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```

```{r}
#Visualization of out of samplefit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions (Forward)",  xlab = " ", ylab = "Price", xaxt = "n")
lines(predict(object = fit_DA_CH_forward, newdata = df_CH_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="German Day Ahead Prices - Predictions (Forward)",  xlab = " ", ylab = "Price", xaxt = "n")
lines(predict(object = fit_DA_DE_forward, newdata = df_DE_DA_test[1:743,]), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="Auction Prices DE-CH - Predictions (Forward)", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,predict(object = fit_AC_DE_CH_forward, newdata = df_DE_CH_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="Auction Prices CH-DE - Predictions (Forward)", xlab = " ", ylab = "Price", xaxt = "n",ylim=c(0,500))
lines(pmax(0,predict(object = fit_AC_CH_DE_forward, newdata = df_CH_DE_AUCT_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```
Evaluating fit of backwards model selection
```{r}
#removing last 24 rows due to shifted data

#First Insights: Every fit seems to be decent, except for the Auction price from 
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743], predict(object = fit_DA_CH_backward, newdata = df_CH_DA_test[1:743,]))
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -predict(object = fit_DA_CH_backward, newdata = df_CH_DA_test[1:743,]))^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], predict(object = fit_DA_DE_backward, newdata = df_DE_DA_test[1:743,]))
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - predict(object = fit_DA_DE_backward, newdata = df_DE_DA_test[1:743,]))^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,predict(object = fit_AC_DE_CH_backward, newdata = df_DE_CH_AUCT_test[1:743,])))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,predict(object = fit_AC_DE_CH_backward, newdata = df_DE_CH_AUCT_test[1:743,])))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,predict(object = fit_AC_CH_DE_backward, newdata = df_CH_DE_AUCT_test[1:743,])))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,predict(object = fit_AC_CH_DE_backward, newdata = df_CH_DE_AUCT_test[1:743,])))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE, Auction_Price_DE_CH )

# Print the result
print(result_table)
```
Again great for modelling German day ahead prices

Checking if a transformed version of the response yields better results
```{r}
### PART ONE: BASELINE MODEL - Linear Regression 

fit_DA_CH= lm(asinh(day_ahead_price_ch)~., data=df_CH_DA_train)
fit_DA_DE= lm(asinh(day_ahead_price_de)~., data=df_DE_DA_train)
fit_AC_CH_DE= lm(asinh(auction_price_ch_de)~., data=df_CH_DE_AUCT_train)
fit_AC_DE_CH= lm(asinh(auction_price_de_ch)~., data=df_DE_CH_AUCT_train )




```


```{r}

#Visualization of fit:
plot(df_CH_DA_train$day_ahead_price_ch, type="l", main="Swiss Day-Ahead Price", xlab="", xaxt = "n", ylab= "Price")
lines(sinh(fit_DA_CH$fitted.values), col="red")
axis(1, at = seq(1, 5831, by = 720), labels = df_CH_DA_train$date[seq(1, 5831, by = 720)], las = 2, cex.axis = 0.7)


plot(df_DE_DA_train$day_ahead_price_de, type="l", main="German Day-Ahead Price", xlab="", xaxt = "n", ylab= "Price")
lines(sinh(fit_DA_DE$fitted.values), col="red")
axis(1, at = seq(1, 5831, by = 720), labels = df_CH_DA_train$date[seq(1, 5831, by = 720)], las = 2, cex.axis = 0.7)


plot(df_DE_CH_AUCT_train$auction_price_de_ch, type="l", main="Auction Price CH-DE", xlab="", xaxt = "n", ylab= "Price")
lines(sinh(fit_AC_DE_CH$fitted.values), col="red")
axis(1, at = seq(1, 5831, by = 720), labels = df_CH_DA_train$date[seq(1, 5831, by = 720)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_train$auction_price_ch_de, type="l", main="Auction Price DE-CH", xlab="", xaxt = "n", ylab= "Price")
lines(sinh(fit_AC_CH_DE$fitted.values), col="red")
axis(1, at = seq(1, 5831, by = 720), labels = df_CH_DA_train$date[seq(1, 5831, by = 720)], las = 2, cex.axis = 0.7)

```
###Resiudal Analysis:###
```{r}
# Plotting the residuals



residuals_DA_price_ch <- residuals(fit_DA_CH)
residuals_DA_price_de  <- residuals(fit_DA_DE)
residuals_auct_CH_DE<- residuals(fit_AC_CH_DE)
#residuals_auct_DE_CH  <- residuals(fit_AC_DE_CH)


# Plot histogram of residuals
#hist(residuals_auct_DE_CH, breaks = 20, main = "Histogram of Residuals")
hist(residuals_auct_CH_DE, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_ch, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_de, breaks = 20, main = "Histogram of Residuals")

# Plot QQ plot of residuals
#qqnorm(residuals_auct_DE_CH)
#qqline(residuals_auct_DE_CH)

qqnorm(residuals_auct_CH_DE)
qqline(residuals_auct_CH_DE)

qqnorm(residuals_DA_price_ch)
qqline(residuals_DA_price_ch)

qqnorm(residuals_DA_price_de)
qqline(residuals_DA_price_de)
```
The residual plots for the day ahead prices might have improved slightly regarding the higher end tail, but the lower end tail deviates a lot from a normal distribution


```{r}
#removing last 24 rows due to shifted data

#First Insights: Every fit seems to be decent, except for the Auction price from 
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743], sinh(predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,])))
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -sinh(predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,])))^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], sinh(predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,])))
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - sinh(predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,])))^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,sinh(predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,]))))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,sinh(predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,]))))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,sinh(predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,]))))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,sinh(predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,]))))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE)#, Auction_Price_DE_CH )

# Print the result
print(result_table)
```



```{r}
#Visualization of out of sample fit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(0,350))
lines(sinh(predict(object = fit_DA_CH, newdata = df_CH_DA_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="fit_DA_DE", ylim=c(-50,350), xlab = " ", ylab = "Price", xaxt = "n")
lines(sinh(predict(object = fit_DA_DE, newdata = df_DE_DA_test[1:743,])), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,sinh(predict(object = fit_AC_DE_CH, newdata = df_DE_CH_AUCT_test[1:743,]))), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,25))
lines(pmax(0,sinh(predict(object = fit_AC_CH_DE, newdata = df_CH_DE_AUCT_test[1:743,]))), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```








#################################################################################################################################################
######################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################







## PART 2: GARCH ONLY###


In the following part, we will use the rugarch package to directly place our 
formula into the GARCH function, in order to see how much this approach deviates
from the mixed model approach we have shown in Part 2  

Running a GARCH model without predictors first
```{r}
# Define the formula including the dependent variable and predictor variables


q_values_arma=seq(1,30,by=1)
p_values_arma=seq(1,30,by=1)
q_values=seq(1,30,by=1)
p_values=seq(1,30,by=1)
results_mat= list(Swiss_DA_Price = list(Inf), 
                German_DA_Price = list(Inf),
                CH_DE_AUCT_Price = list(Inf),
                DE_CH_AUCT_Price = list(Inf))

#for (q_arma in q_values_arma){
  #for (p_arma in p_values_arma){
    #for (q_garch in q_value){
      #for (p_garch in p_values){
q_arma=p_arma=25
q_garch=p_garch=25
         #tryCatch({
        
        
          garch_model <- ugarchspec(mean.model = list(armaOrder = c(q_arma,p_values_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(q_garch, p_garch)), 
                                    distribution.model = "norm")
  
  
          
          # Fit the GARCH model to the data
          fit_DA_price_ch <- ugarchfit(garch_model, data = df_CH_DA_train$day_ahead_price_ch )
          fit_DA_price_de <- ugarchfit(garch_model, data = df_DE_DA_train$day_ahead_price_de)
          fit_auction_CH_DE <- ugarchfit(garch_model, data = df_CH_DE_AUCT_train$auction_price_ch_de)
          fit_auction_DE_CH <- ugarchfit(garch_model, data = df_DE_CH_AUCT_train$auction_price_de_ch)
          
```



```{r}
save(fit_DA_price_ch, fit_DA_price_de, fit_auction_CH_DE, fit_auction_DE_CH, file = "fitted_garch_models.RData")

          
          fitted_values_DA_CH= fitted(fit_DA_price_ch)
          fitted_values_DA_DE= fitted(fit_DA_price_de)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_CH_DE)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_DE_CH)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2) 
          
          
          current_params_DA_CH <- list(MSE= mse_DA_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_DA_DE <- list(MSE= mse_DA_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_CH_DE <- list(MSE= mse_AUCT_CH_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_DE_CH <- list(MSE= mse_AUCT_DE_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
  
          if (results_mat$Swiss_DA_Price[1] > mse_DA_CH){
            results_mat$Swiss_DA_Price= current_params_DA_CH}
  
          if (results_mat$German_DA_Price[1] > mse_DA_DE){
            results_mat$German_DA_Price= current_params_DA_DE}
          
          if (results_mat$CH_DE_AUCT_Price[1] > mse_AUCT_CH_DE){
            results_mat$CH_DE_AUCT_Price= current_params_AUCT_CH_DE}
          
          if (results_mat$DE_CH_AUCT_Price[1] > mse_AUCT_DE_CH){
            results_mat$DE_CH_AUCT_Price= current_params_AUCT_DE_CH}
          
        #}, error = function(e) {
         # cat("An error occurred:", conditionMessage(e), "\n")
          # Optionally, handle the error here, e.g., by skipping to the next iteration
          # next iteration
        #})
     # }
    #}
 # }
#  print(q_arma)
#}
# Define the GARCH model specification

```



```{r}
forecast_DA_price_ch <- ugarchforecast(fit_DA_price_ch, n.ahead = 743)
forecast_DA_price_de <- ugarchforecast(fit_DA_price_de, n.ahead = 743)
forecast_auction_CH_DE <- ugarchforecast(fit_auction_CH_DE, n.ahead = 743)
forecast_auction_DE_CH <- ugarchforecast(fit_auction_DE_CH, n.ahead = 743)

# Extract the forecasted values (mean forecast)
predicted_values_DA_CH <- fitted(forecast_DA_price_ch)
predicted_values_DA_DE <- fitted(forecast_DA_price_de)
predicted_values_AUCT_DE_CH <- fitted(forecast_auction_CH_DE)
predicted_values_AUCT_CH_DE <- fitted(forecast_auction_DE_CH)



#First Insights: Every fit seems to be decent, except for the Auction price from 
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743],predicted_values_DA_CH)
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -predicted_values_DA_CH)^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], predicted_values_DA_DE)
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - predicted_values_DA_DE)^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,predicted_values_AUCT_DE_CH))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,predicted_values_AUCT_CH_DE))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,predicted_values_AUCT_CH_DE))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,predicted_values_AUCT_CH_DE))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE, Auction_Price_DE_CH )

# Print the result
print(result_table)
```
--> For many cases already better than the linear Regression


```{r}
#Visualization of out of sample fit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(0,350))
lines(predicted_values_DA_CH, col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="fit_DA_DE", ylim=c(-50,350), xlab = " ", ylab = "Price", xaxt = "n")
lines(predicted_values_DA_DE, col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,predicted_values_AUCT_DE_CH), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,25))
lines(pmax(0,predicted_values_AUCT_CH_DE), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```
--> Prediction is  super bad

##################################################################################################################################################################################################################################################################################################


##2.1 Running Garch model on transformed response:

```{r}
# Define the formula including the dependent variable and predictor variables


q_values_arma=seq(1,30,by=1)
p_values_arma=seq(1,30,by=1)
q_values=seq(1,30,by=1)
p_values=seq(1,30,by=1)
results_mat= list(Swiss_DA_Price = list(Inf), 
                German_DA_Price = list(Inf),
                CH_DE_AUCT_Price = list(Inf),
                DE_CH_AUCT_Price = list(Inf))

#for (q_arma in q_values_arma){
  #for (p_arma in p_values_arma){
    #for (q_garch in q_value){
      #for (p_garch in p_values){
q_arma=p_arma=25
q_garch=p_garch=25
         #tryCatch({
        
        
          garch_model <- ugarchspec(mean.model = list(armaOrder = c(q_arma,p_values_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(q_garch, p_garch)), 
                                    distribution.model = "norm")
  
  
          
          # Fit the GARCH model to the data
          fit_DA_price_ch_asinh <- ugarchfit(garch_model, data = asinh(df_CH_DA_train$day_ahead_price_ch))
          fit_DA_price_de_asinh <- ugarchfit(garch_model, data = asinh(df_DE_DA_train$day_ahead_price_de))
          fit_auction_CH_DE_asinh <- ugarchfit(garch_model, data = asinh(df_CH_DE_AUCT_train$auction_price_ch_de))
          fit_auction_DE_CH_asinh <- ugarchfit(garch_model, data = asinh(df_DE_CH_AUCT_train$auction_price_de_ch))
          
```

```{r}
# Define the formula including the dependent variable and predictor variables


q_values_arma=seq(1,30,by=1)
p_values_arma=seq(1,30,by=1)
q_values=seq(1,30,by=1)
p_values=seq(1,30,by=1)
results_mat= list(Swiss_DA_Price = list(Inf), 
                German_DA_Price = list(Inf),
                CH_DE_AUCT_Price = list(Inf),
                DE_CH_AUCT_Price = list(Inf))

for (q_arma in q_values_arma){
  for (p_arma in p_values_arma){
    for (q_garch in q_values){
      for (p_garch in p_values){
#q_arma=p_arma=25
#q_garch=p_garch=25
         tryCatch({
        
        
          garch_model <- ugarchspec(mean.model = list(armaOrder = c(q_arma,p_values_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(q_garch, p_garch)), 
                                    distribution.model = "norm")
  
  
          
          # Fit the GARCH model to the data
          fit_DA_price_ch <- ugarchfit(garch_model, data = df_CH_DA_train$day_ahead_price_ch )
          fit_DA_price_de <- ugarchfit(garch_model, data = df_DE_DA_train$day_ahead_price_de)
          fit_auction_CH_DE <- ugarchfit(garch_model, data = df_CH_DE_AUCT_train$auction_price_ch_de)
          fit_auction_DE_CH <- ugarchfit(garch_model, data = df_DE_CH_AUCT_train$auction_price_de_ch)
          

#save(fit_DA_price_ch, fit_DA_price_de, fit_auction_CH_DE, fit_auction_DE_CH, file = "fitted_garch_models.RData")

          
          fitted_values_DA_CH= fitted(fit_DA_price_ch)
          fitted_values_DA_DE= fitted(fit_DA_price_de)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_CH_DE)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_DE_CH)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2) 
          
          
          current_params_DA_CH <- list(MSE= mse_DA_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_DA_DE <- list(MSE= mse_DA_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_CH_DE <- list(MSE= mse_AUCT_CH_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_DE_CH <- list(MSE= mse_AUCT_DE_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
  
          if (results_mat$Swiss_DA_Price[1] > mse_DA_CH){
            results_mat$Swiss_DA_Price= current_params_DA_CH}
  
          if (results_mat$German_DA_Price[1] > mse_DA_DE){
            results_mat$German_DA_Price= current_params_DA_DE}
          
          if (results_mat$CH_DE_AUCT_Price[1] > mse_AUCT_CH_DE){
            results_mat$CH_DE_AUCT_Price= current_params_AUCT_CH_DE}
          
          if (results_mat$DE_CH_AUCT_Price[1] > mse_AUCT_DE_CH){
            results_mat$DE_CH_AUCT_Price= current_params_AUCT_DE_CH}
          
        }, error = function(e) {
          cat("An error occurred:", conditionMessage(e), "\n")
        })
      }
    }
  }
}

#training loop for best vaues
``` 

```{r}
save(fit_DA_price_ch_asinh, fit_DA_price_de_asinh, fit_auction_CH_DE_asinh, fit_auction_DE_CH_asinh, file = "fitted_garch_models.RData")
```



Models are terrible

########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################


#2.2 GARCH with predictor variables: GARCH PROCESS BUT NO ARIMA
feeding predictors in --> does not work, 
selecting subset of predictors --> does not work
lets try with normalized data --> does still not work
lets try if it works for any kind of p and q values
lets change the solver methods

lets get rid of predictors with a high VIF so to avoid singular matrices



```{r}
# Define the formula including the dependent variable and predictor variables
df_CH_DA_train_GARCH <- df_CH_DA_train %>%
  mutate(across(where(is.numeric), ~ scale(.) %>% as.vector()))
#df_CH_DA_train_GARCH$day_ahead_price_ch=df_CH_DA_train$day_ahead_price_ch

df_DE_DA_train_GARCH <- df_DE_DA_train %>%
  mutate(across(where(is.numeric), ~ scale(.) %>% as.vector()))
#df_DE_DA_train_GARCH$day_ahead_price_de=df_DE_DA_train$day_ahead_price_de


df_CH_DE_AUCT_train_GARCH <- df_CH_DE_AUCT_train %>%
  mutate(across(where(is.numeric), ~ scale(.) %>% as.vector()))
#df_CH_DE_AUCT_train_GARCH$auction_price_ch_de=df_CH_DE_AUCT_train$auction_price_ch_de


df_DE_CH_AUCT_train_GARCH <- df_DE_CH_AUCT_train %>%
  mutate(across(where(is.numeric), ~ scale(.) %>% as.vector()))
#df_DE_CH_AUCT_train_GARCH$auction_price_de_ch=df_DE_CH_AUCT_train$auction_price_de_ch

df_CH_DA_train= arrange(df_CH_DA_train, date)
fit_cleaning= lm(day_ahead_price_ch~., data=df_CH_DA_train)
# Identify predictors with NA coefficients (indicating rank deficiency)
na_predictors <- names(fit_cleaning$coefficients)[is.na(fit_cleaning$coefficients)]
#Issue columns are c("cal_month" ,"cal_quarter","cal_week_in_year" ,"cal_year","g3_dummy")


# Prepare the data matrix excluding the target variable and date
X_regtrain_DA_CH <- select(df_CH_DA_train_GARCH, -c("day_ahead_price_ch", "date","cal_month" ,"cal_quarter"))
X_regtrain_DA_DE <- select(df_DE_DA_train_GARCH, -c("day_ahead_price_de", "date","cal_month" ,"cal_quarter"))
X_regtrain_CH_DE_AUCT <- select(df_CH_DE_AUCT_train_GARCH, -c("auction_price_ch_de", "date","cal_month" ,"cal_quarter"))
X_regtrain_DE_CH_AUCT <- select(df_DE_CH_AUCT_train_GARCH, -c("auction_price_de_ch", "date","cal_month" ,"cal_quarter"))


# Fit a linear model to calculate VIF
linear_model_DA_CH <- lm(df_CH_DA_train_GARCH$day_ahead_price_ch ~ ., data = X_regtrain_DA_CH)
linear_model_DA_DE <- lm(df_DE_DA_train_GARCH$day_ahead_price_de ~ ., data = X_regtrain_DA_DE)
linear_model_CH_DE_AUCT <- lm(df_CH_DE_AUCT_train_GARCH$auction_price_ch_de ~ ., data = X_regtrain_CH_DE_AUCT)
linear_model_DE_CH_AUCT <- lm(df_DE_CH_AUCT_train_GARCH$auction_price_de_ch ~ ., data = X_regtrain_DE_CH_AUCT)


# Calculate VIF for each predictor
vif_values_DA_CH <- vif(linear_model_DA_CH)
vif_values_DA_DE <- vif(linear_model_DA_DE)
vif_values_CH_DE_AUCT <- vif(linear_model_CH_DE_AUCT)
vif_values_DE_CH_AUCT <- vif(linear_model_CH_DE_AUCT)


# Identify columns with high VIF values (e.g., VIF > 10)
high_vif_columns_DA_CH <- names(vif_values_DA_CH)[vif_values_DA_CH > 10]
high_vif_columns_DA_DE <- names(vif_values_DA_DE)[vif_values_DA_DE > 10]
high_vif_columns_CH_DE_AUCT <- names(vif_values_CH_DE_AUCT)[vif_values_CH_DE_AUCT > 10]
high_vif_columns_DE_CH_AUCT <- names(vif_values_DE_CH_AUCT)[vif_values_DE_CH_AUCT > 10]

# Remove columns with high VIF
X_regtrain_filtered_DA_CH <- as.matrix(select(df_CH_DA_train_GARCH, -c("day_ahead_price_ch", "date","cal_month" ,"cal_quarter", high_vif_columns_DA_CH)))
X_regtrain_filtered_DA_DE <-  as.matrix(select(df_DE_DA_train_GARCH, -c("day_ahead_price_de", "date","cal_month" ,"cal_quarter",high_vif_columns_DA_DE)))
X_regtrain_filtered_CH_DE_AUCT<-  as.matrix(select(df_CH_DE_AUCT_train_GARCH, -c("auction_price_ch_de", "date","cal_month" ,"cal_quarter", high_vif_columns_CH_DE_AUCT)))
X_regtrain_filtered_DE_CH_AUCT <-  as.matrix(select(df_DE_CH_AUCT_train_GARCH, -c("auction_price_de_ch", "date","cal_month" ,"cal_quarter", high_vif_columns_DE_CH_AUCT)))

X_regtrain_filtered_DA_CH <- apply(X_regtrain_filtered_DA_CH, 2, as.numeric)
X_regtrain_filtered_DA_DE <- apply(X_regtrain_filtered_DA_DE, 2, as.numeric)
X_regtrain_filtered_CH_DE_AUCT <- apply(X_regtrain_filtered_CH_DE_AUCT, 2, as.numeric)
X_regtrain_filtered_DE_CH_AUCT <- apply(X_regtrain_filtered_DE_CH_AUCT, 2, as.numeric)




# Check if the matrix is now invertible
invertible_matrix_DA_CH <- try(solve(t(X_regtrain_filtered_DA_CH) %*% X_regtrain_filtered_DA_CH), silent = TRUE)
invertible_matrix_DA_DE <- try(solve(t(X_regtrain_filtered_DA_DE) %*% X_regtrain_filtered_DA_DE), silent = TRUE)
invertible_matrix_CH_DE_AUCT <- try(solve(t(X_regtrain_filtered_CH_DE_AUCT) %*% X_regtrain_filtered_CH_DE_AUCT), silent = TRUE)
invertible_matrix_DA_CH_AUCT <- try(solve(t(X_regtrain_filtered_DE_CH_AUCT) %*% X_regtrain_filtered_DE_CH_AUCT), silent = TRUE)

# Display result
if (inherits(invertible_matrix_DA_CH, "try-error")) {
  cat("The matrix DA_CH is still singular after removing high VIF columns.\n")
} else {
  cat("The matrix DA_CH is invertible.\n")}

if (inherits(invertible_matrix_DA_DE, "try-error")) {
  cat("The matrix DA_DE is still singular after removing high VIF columns.\n")
} else {
  cat("The matrix DA_DE is invertible.\n")}

if (inherits(invertible_matrix_CH_DE_AUCT, "try-error")) {
  cat("The matrix _CH_DE_AUCT is still singular after removing high VIF columns.\n")
} else {
  cat("The matrix _CH_DE_AUCT is invertible.\n")}

if (inherits(invertible_matrix_DA_CH_AUCT, "try-error")) {
  cat("The matrix _DA_CH_AUCT is still singular after removing high VIF columns.\n")
} else {
  cat("The matrix _DA_CH_AUCT is invertible.\n")}
```




```{r}

df_CH_DA_train_GARCH=X_regtrain_filtered_DA_CH
df_DE_DA_train_GARCH=X_regtrain_filtered_DA_DE
df_CH_DE_AUCT_train_GARCH=X_regtrain_filtered_CH_DE_AUCT 
df_DE_CH_AUCT_train_GARCH=X_regtrain_filtered_DE_CH_AUCT 

formula_DA_price_ch <- df_CH_DA_train$day_ahead_price_ch ~.
ormula_DA_price_de  <- df_DE_DA_train$day_ahead_price_de ~. 
formula_auction_DE_CH  <- df_CH_DE_AUCT_train$auction_price_ch_de ~. 
formula_auction_CH_DE <- df_DE_CH_AUCT_train$auction_price_de_ch ~. 

q_values_arma=seq(24,26,by=1) #solver fails to converge if not set to 0
p_values_arma=seq(24,26,by=1) #solver fails to converge if not set to 0
q_values=seq(24,26,by=1)
p_values=seq(24,26,by=1)
results_mat= list(Swiss_DA_Price = list(Inf), 
                German_DA_Price = list(Inf),
                CH_DE_AUCT_Price = list(Inf),
                DE_CH_AUCT_Price = list(Inf))

for (q_arma in q_values_arma){
  for (p_arma in p_values_arma){
    for (q_garch in q_values){
      for (p_garch in p_values){
         tryCatch({
           cat("with q_arma = ", q_arma, " and p_arma = ", p_arma, " --> MSE: ", "AND with q_garch = ", q_garch,"with p_garch = ", p_garch, "\n")

        
        
          garch_model <- ugarchspec(mean.model = list(armaOrder = c(q_arma,p_values_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(q_garch, p_garch)), 
                                    distribution.model = "norm")
  
  
          
          # Fit the GARCH model to the data
          fit_DA_price_ch <- ugarchfit(garch_model, data = df_CH_DA_train_GARCH, formula = formula_DA_price_ch,  solver = "hyprid")
          fit_DA_price_de <- ugarchfit(garch_model, data = df_DE_DA_train_GARCH, formula = formula_DA_price_de,  solver = "hyprid")
          fit_auction_CH_DE <- ugarchfit(garch_model, data = df_CH_DE_AUCT_train_GARCH, formula = formula_auction_CH_DE,  solver = "hyprid")
          fit_auction_DE_CH <- ugarchfit(garch_model, data = df_DE_CH_AUCT_train_GARCH, formula = formula_auction_DE_CH,  solver = "hyprid")
          
          fitted_values_DA_CH= fitted(fit_DA_price_ch)*sd(df_CH_DA_train$day_ahead_price_ch) + mean(df_CH_DA_train$day_ahead_price_ch)
          fitted_values_DA_DE= fitted(fit_DA_price_de)*sd(df_DE_DA_train$day_ahead_price_de) + mean(df_DE_DA_train$day_ahead_price_de)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_CH_DE)*sd(df_CH_DE_AUCT_train$auction_price_ch_de) + mean(df_CH_DE_AUCT_train$auction_price_ch_de)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_DE_CH)*sd(df_DE_CH_AUCT_train$auction_price_de_ch) + mean(df_DE_CH_AUCT_train$auction_price_de_ch)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2) 
          
          
          current_params_DA_CH <- list(MSE= mse_DA_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_DA_DE <- list(MSE= mse_DA_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_CH_DE <- list(MSE= mse_AUCT_CH_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_DE_CH <- list(MSE= mse_AUCT_DE_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
  
          if (results_mat$Swiss_DA_Price[1] > mse_DA_CH){
            results_mat$Swiss_DA_Price= current_params_DA_CH}
  
          if (results_mat$German_DA_Price[1] > mse_DA_DE){
            results_mat$German_DA_Price= current_params_DA_DE}
          
          if (results_mat$CH_DE_AUCT_Price[1] > mse_AUCT_CH_DE){
            results_mat$CH_DE_AUCT_Price= current_params_AUCT_CH_DE}
          
          if (results_mat$DE_CH_AUCT_Price[1] > mse_AUCT_DE_CH){
            results_mat$DE_CH_AUCT_Price= current_params_AUCT_DE_CH}
          
        }, error = function(e) {
          cat("An error occurred:", conditionMessage(e), "\n")

        })
      }
    }
  }
}

# This approach does not really work
```


```{r}
# Save the models to a file
save(fit_DA_price_ch, fit_DA_price_de, fit_auction_CH_DE, fit_auction_DE_CH, file = "garch_models_ARMA_0_0_GARCH_30_30.RData")

# Optionally, print a message to confirm saving
cat("Models have been saved to garch_models.RData\n")
```

```{r}
          garch_model_Swiss_DA <- ugarchspec(mean.model = list(armaOrder = c(results_mat$Swiss_DA_Price$q_arma,results_mat$Swiss_DA_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$Swiss_DA_Price$q_garch, results_mat$Swiss_DA_Price$p_garch)), 
                                    distribution.model = "norm")  
          garch_model_German_DA <- ugarchspec(mean.model = list(armaOrder = c(results_mat$German_DA_Price$q_arma,results_mat$German_DA_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$German_DA_Price$q_garch, results_mat$German_DA_Price$p_garch)), 
                                    distribution.model = "norm") 
          garch_model_Auct_CH_DE <- ugarchspec(mean.model = list(armaOrder = c(results_mat$CH_DE_AUCT_Price$q_arma,results_mat$CH_DE_AUCT_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$CH_DE_AUCT_Price$q_garch, results_mat$CH_DE_AUCT_Price$p_garch)), 
                                    distribution.model = "norm") 
          garch_model_AUCT_DE_CH <- ugarchspec(mean.model = list(armaOrder = c(results_mat$DE_CH_AUCT_Price$q_arma,results_mat$DE_CH_AUCT_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$DE_CH_AUCT_Price$q_garch, results_mat$DE_CH_AUCT_Price$p_garch)), 
                                    distribution.model = "norm") 


          fit_DA_price_ch_optim_paras_ARAM_0_0 <- ugarchfit(garch_model_Swiss_DA, data = df_CH_DA_train_GARCH, formula = formula_DA_price_ch)
          fit_DA_price_de_optim_paras_ARAM_0_0  <- ugarchfit(garch_model_German_DA, data = df_DE_DA_train_GARCH, formula = formula_DA_price_de)
          fit_auction_CH_DE_optim_paras_ARAM_0_0  <- ugarchfit(garch_model_Auct_CH_DE, data = df_CH_DE_AUCT_train_GARCH, formula = formula_auction_CH_DE)
          fit_auction_DE_CH_optim_paras_ARAM_0_0  <- ugarchfit(garch_model_AUCT_DE_CH, data = df_DE_CH_AUCT_train_GARCH, formula = formula_auction_DE_CH)
          
          
          fitted_values_DA_CH= fitted(fit_DA_price_ch_optim_paras_ARAM_0_0)
          fitted_values_DA_DE= fitted(fit_DA_price_de_optim_paras_ARAM_0_0)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_CH_DE_optim_paras_ARAM_0_0)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_DE_CH_optim_paras_ARAM_0_0)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2)
          

          
```


```{r}
          predicted_values_DA_CH <- fitted(ugarchforecast(fit_DA_price_ch_optim_paras_ARAM_0_0, n.ahead = 743))
          predicted_values_DA_DE <- fitted(ugarchforecast(fit_DA_price_de_optim_paras_ARAM_0_0, n.ahead = 743))
          predicted_values_AUCT_DE_CH <- fitted(ugarchforecast(fit_auction_CH_DE_optim_paras_ARAM_0_0, n.ahead = 743))
          predicted_values_AUCT_CH_DE <- fitted(ugarchforecast(fit_auction_DE_CH_optim_paras_ARAM_0_0, n.ahead = 743))
#First Insights: Every fit seems to be decent, except for the Auction price from 
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743],predicted_values_DA_CH)
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -predicted_values_DA_CH)^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], predicted_values_DA_DE)
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - predicted_values_DA_DE)^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,predicted_values_AUCT_DE_CH))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,predicted_values_AUCT_CH_DE))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,predicted_values_AUCT_CH_DE))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,predicted_values_AUCT_CH_DE))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE, Auction_Price_DE_CH )

# Print the result
print(result_table)
          
         
```


```{r}
#Visualization of out of sample fit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(0,350))
lines(predicted_values_DA_CH, col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="fit_DA_DE", ylim=c(-50,350), xlab = " ", ylab = "Price", xaxt = "n")
lines(predicted_values_DA_DE, col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,predicted_values_AUCT_DE_CH), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,25))
lines(pmax(0,predicted_values_AUCT_CH_DE), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```





```{r}

df_CH_DA_train_GARCH=X_regtrain_filtered_DA_CH
df_DE_DA_train_GARCH=X_regtrain_filtered_DA_DE
df_CH_DE_AUCT_train_GARCH=X_regtrain_filtered_CH_DE_AUCT 
df_DE_CH_AUCT_train_GARCH=X_regtrain_filtered_DE_CH_AUCT 

formula_DA_price_ch <- df_CH_DA_train$day_ahead_price_ch ~.
ormula_DA_price_de  <- df_DE_DA_train$day_ahead_price_de ~. 
formula_auction_DE_CH  <- df_CH_DE_AUCT_train$auction_price_ch_de ~. 
formula_auction_CH_DE <- df_DE_CH_AUCT_train$auction_price_de_ch ~. 

q_values_arma=0 #solver fails to converge if not set to 0
p_values_arma=0 #solver fails to converge if not set to 0
q_values=seq(1,30,by=1)
p_values=seq(1,30,by=1)
results_mat= list(Swiss_DA_Price = list(Inf), 
                German_DA_Price = list(Inf),
                CH_DE_AUCT_Price = list(Inf),
                DE_CH_AUCT_Price = list(Inf))

for (q_arma in q_values_arma){
  for (p_arma in p_values_arma){
    for (q_garch in q_values){
      for (p_garch in p_values){
         tryCatch({
           cat("with q_arma = ", q_arma, " and p_arma = ", p_arma, " --> MSE: ", "AND with q_garch = ", q_garch,"with p_garch = ", p_garch, "\n")

        
        
          garch_model <- ugarchspec(mean.model = list(armaOrder = c(q_arma,p_values_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(q_garch, p_garch)), 
                                    distribution.model = "norm")
  
  
          
          # Fit the GARCH model to the data
          fit_DA_price_ch <- ugarchfit(garch_model, data = df_CH_DA_train_GARCH, formula = formula_DA_price_ch)
          fit_DA_price_de <- ugarchfit(garch_model, data = df_DE_DA_train_GARCH, formula = formula_DA_price_de)
          fit_auction_CH_DE <- ugarchfit(garch_model, data = df_CH_DE_AUCT_train_GARCH, formula = formula_auction_CH_DE)
          fit_auction_DE_CH <- ugarchfit(garch_model, data = df_DE_CH_AUCT_train_GARCH, formula = formula_auction_DE_CH)
          
          fitted_values_DA_CH= fitted(fit_DA_price_ch)*sd(df_CH_DA_train$day_ahead_price_ch) + mean(df_CH_DA_train$day_ahead_price_ch)
          fitted_values_DA_DE= fitted(fit_DA_price_de)*sd(df_DE_DA_train$day_ahead_price_de) + mean(df_DE_DA_train$day_ahead_price_de)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_CH_DE)*sd(df_CH_DE_AUCT_train$auction_price_ch_de) + mean(df_CH_DE_AUCT_train$auction_price_ch_de)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_DE_CH)*sd(df_DE_CH_AUCT_train$auction_price_de_ch) + mean(df_DE_CH_AUCT_train$auction_price_de_ch)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2) 
          
          
          current_params_DA_CH <- list(MSE= mse_DA_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_DA_DE <- list(MSE= mse_DA_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_CH_DE <- list(MSE= mse_AUCT_CH_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_DE_CH <- list(MSE= mse_AUCT_DE_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
  
          if (results_mat$Swiss_DA_Price[1] > mse_DA_CH){
            results_mat$Swiss_DA_Price= current_params_DA_CH}
  
          if (results_mat$German_DA_Price[1] > mse_DA_DE){
            results_mat$German_DA_Price= current_params_DA_DE}
          
          if (results_mat$CH_DE_AUCT_Price[1] > mse_AUCT_CH_DE){
            results_mat$CH_DE_AUCT_Price= current_params_AUCT_CH_DE}
          
          if (results_mat$DE_CH_AUCT_Price[1] > mse_AUCT_DE_CH){
            results_mat$DE_CH_AUCT_Price= current_params_AUCT_DE_CH}
          
        }, error = function(e) {
          cat("An error occurred:", conditionMessage(e), "\n")

        })
      }
    }
  }
}

```



```{r}


###Resiudal Analysis:###

# Plotting the residuals
residuals_auct_DE_CH <- residuals(fit_auction_DE_CH)
residuals_auct_CH_DE <- residuals(fit_auction_CH_DE)
residuals_DA_price_ch<- residuals(fit_DA_price_ch)
residuals_DA_price_de <- residuals(fit_DA_price_de)


# Plot histogram of residuals
hist(residuals_auct_DE_CH, breaks = 20, main = "Histogram of Residuals")
hist(residuals_auct_CH_DE, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_ch, breaks = 20, main = "Histogram of Residuals")
hist(residuals_DA_price_de, breaks = 20, main = "Histogram of Residuals")

# Plot QQ plot of residuals
qqnorm(residuals_auct_DE_CH)
qqline(residuals_auct_DE_CH)

qqnorm(residuals_auct_CH_DE)
qqline(residuals_auct_CH_DE)

qqnorm(residuals_DA_price_ch)
qqline(residuals_DA_price_ch)

qqnorm(residuals_DA_price_de)
qqline(residuals_DA_price_de)

#### --> Residuals are not normally distributed: ISsue....

###Calculate MSE
# Predictions from the GARCH model
predictions1 <- fitted(fit_auction_DE_CH)
predictions2 <- fitted(fit_auction_CH_DE)
predictions3 <- fitted(fit_DA_price_ch)
predictions4 <- fitted(fit_DA_price_de)


# Actual values of the dependent variable
actual_values1 <- data_stationary$auction_price_de_ch  # Assuming 'y' is your dependent variable in the original data
actual_values2<- data_stationary$auction_price_ch_de # Assuming 'y' is your dependent variable in the original data
actual_values3 <- data_stationary$day_ahead_price_ch  # Assuming 'y' is your dependent variable in the original data
actual_values4 <- data_stationary$day_ahead_price_de  # Assuming 'y' is your dependent variable in the original data

# Calculate Mean Squared Error
mse1 <- mean((actual_values1 - predictions1)^2)
mse2 <- mean((actual_values2 - predictions2)^2)
mse3 <- mean((actual_values3 - predictions3)^2)
mse4 <- mean((actual_values4 - predictions4)^2)

# Print MSE
print(paste("Mean Squared Error (MSE):", mse1))
print(paste("Mean Squared Error (MSE):", mse2))
print(paste("Mean Squared Error (MSE):", mse3))
print(paste("Mean Squared Error (MSE):", mse4))

var(data_stationary$auction_price_ch_de)
var(data_stationary$auction_price_de_ch)
var(data_stationary$day_ahead_price_ch)
var(data_stationary$day_ahead_price_de)




```
As the MSE is basically equal to the variance of the stationarized data, this approach does not seem to really work




########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
#2.4 GARCH AND ARMA PROCESSES



```{r}
df_CH_DA_train_numeric <- as.data.frame(lapply(df_CH_DA_train, function(x) as.numeric(as.character(x))))
df_DE_DA_train_numeric <- as.data.frame(lapply(df_DE_DA_train, function(x) as.numeric(as.character(x))))
df_DE_CH_AUCT_train_numeric <- as.data.frame(lapply(df_DE_CH_AUCT_train, function(x) as.numeric(as.character(x))))
df_CH_DE_AUCT_train_numeric <- as.data.frame(lapply(df_CH_DE_AUCT_train, function(x) as.numeric(as.character(x))))

xreg_train_CH_DA <- select(df_CH_DA_train_numeric, -c("day_ahead_price_ch", "date")) %>%
  as.matrix()
xreg_train_DE_DA <- select(df_DE_DA_train_numeric, -c("day_ahead_price_de", "date"))%>%
  as.matrix()
xreg_train_DE_CH_AUCT <- select(df_DE_CH_AUCT_train_numeric, -c("auction_price_de_ch", "date")) %>%
  as.matrix()
xreg_train_CH_DE_AUCT <- select(df_CH_DE_AUCT_train_numeric, -c("auction_price_ch_de", "date")) %>%
  as.matrix()

# rank of the matrix to invert in ARIMA:

pivotal_columns <- function(X){
  rank<- qr(t(X) %*% X)$rank
  n <- ncol(X)
  pivotal_columns <- numeric(0)
  
  for (i in 1:n) {
    # Include the current column in the test matrix
    test_matrix <- X[,-i]
    
    # Check if the rank remains 173
    if (qr(t(test_matrix)%*%test_matrix)$rank != rank) {
      pivotal_columns <- c(pivotal_columns, i)
    }
  }
  return(pivotal_columns)
}

pivot_col_CH_DA <- pivotal_columns(xreg_train_CH_DA)
pivot_col_DE_DA <- pivotal_columns(xreg_train_DE_DA)
pivot_col_DE_CH_AUCT <- pivotal_columns(xreg_train_DE_CH_AUCT)
pivot_col_CH_DE_AUCT <- pivotal_columns(xreg_train_CH_DE_AUCT)
```

```{r}

# names of pivotal columns (columns to keep)
#c("date", 
# "auction_price_ch_de",
#names(select(df_train,-c("auction_price_ch_de","date"))[,pivot_col]))

# reduce xreg to pivotal columns only
xreg_train_CH_DA<- select(df_CH_DA_train_numeric, -c("day_ahead_price_ch", "date"))[, pivot_col_CH_DA]
xreg_train_DE_DA<- select(df_CH_DA_train_numeric, -c("day_ahead_price_de", "date"))[, pivot_col_DE_DA]
xreg_train_DE_CH_AUCT<- select(df_CH_DA_train_numeric, -c("auction_price_de_ch", "date"))[, pivot_col_DE_CH_AUCT]
xreg_train_CH_DE_AUCT<- select(df_CH_DA_train_numeric, -c("auction_price_ch_de", "date"))[, pivot_col_CH_DE_AUCT]

CH_DA_price= df_CH_DA_train$day_ahead_price_ch
DE_DA_price= df_DE_DA_train$day_ahead_price_de
AUCT_CH_DE_price= df_CH_DE_AUCT_train$auction_price_ch_de
AUCT_DE_CH_price= df_DE_CH_AUCT_train$auction_price_de_ch

```


```{r}
normalize <- function(df) {
  normalized <- data.frame(matrix(NA, nrow = nrow(df), ncol = ncol(df)))
  for (i in 1:ncol(df)) {
    col_mean <- mean(df[[i]], na.rm = TRUE)
    col_sd <- sd(df[[i]], na.rm = TRUE)
    normalized[[i]] <- (df[[i]] - col_mean) / col_sd
  }
  names(normalized) <- names(df)
  return(normalized)
}
# Apply the normalization function to all columns of the data frame
normalized_df <-normalize(xreg_train_CH_DA)


df_CH_DA_train_GARCH=  normalize(xreg_train_CH_DA) 

df_DE_DA_train_GARCH=normalize(xreg_train_DE_DA) 


df_CH_DE_AUCT_train_GARCH= normalize(xreg_train_CH_DE_AUCT) 


df_DE_CH_AUCT_train_GARCH=  normalize(xreg_train_DE_CH_AUCT)



formula_DA_price_ch <- df_CH_DA_train$day_ahead_price_ch ~.
ormula_DA_price_de  <- df_DE_DA_train$day_ahead_price_de ~. 
formula_auction_DE_CH  <- df_CH_DE_AUCT_train$auction_price_ch_de ~. 
formula_auction_CH_DE <- df_DE_CH_AUCT_train$auction_price_de_ch ~. 

q_values_arma=1 #solver fails to converge if not set to 0
p_values_arma=1#solver fails to converge if not set to 0
q_values= 5
p_values= 5
results_mat= list(Swiss_DA_Price = list(Inf), 
                German_DA_Price = list(Inf),
                CH_DE_AUCT_Price = list(Inf),
                DE_CH_AUCT_Price = list(Inf))

for (q_arma in q_values_arma){
  for (p_arma in p_values_arma){
    for (q_garch in q_values){
      for (p_garch in p_values){
         tryCatch({
           cat("with q_arma = ", q_arma, " and p_arma = ", p_arma, " --> MSE: ", "AND with q_garch = ", q_garch,"with p_garch = ", p_garch, "\n")

          formula_DA_price_ch <- df_CH_DA_train$day_ahead_price_ch ~.
          formula_DA_price_de  <- df_DE_DA_train$day_ahead_price_de ~. 
          formula_auction_DE_CH  <- df_CH_DE_AUCT_train$auction_price_ch_de ~. 
          formula_auction_CH_DE <- df_DE_CH_AUCT_train$auction_price_de_ch ~.         
        
          garch_model <- ugarchspec(mean.model = list(armaOrder = c(q_arma,p_values_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(q_garch, p_garch)), 
                                    distribution.model = "std")
  
  
          
          # Fit the GARCH model to the data
          fit_DA_price_ch <- ugarchfit(garch_model, data = df_CH_DA_train_GARCH, formula = formula_DA_price_ch)
          fit_DA_price_de <- ugarchfit(garch_model, data = df_DE_DA_train_GARCH, formula = formula_DA_price_de)
          fit_auction_CH_DE <- ugarchfit(garch_model, data = df_CH_DE_AUCT_train_GARCH, formula = formula_auction_CH_DE)
          fit_auction_DE_CH <- ugarchfit(garch_model, data = df_DE_CH_AUCT_train_GARCH, formula = formula_auction_DE_CH)
          
          fitted_values_DA_CH= fitted(fit_DA_price_ch)*sd(df_CH_DA_train$day_ahead_price_ch) + mean(df_CH_DA_train$day_ahead_price_ch)
          fitted_values_DA_DE= fitted(fit_DA_price_de)*sd(df_DE_DA_train$day_ahead_price_de) + mean(df_DE_DA_train$day_ahead_price_de)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_CH_DE)*sd(df_CH_DE_AUCT_train$auction_price_ch_de) + mean(df_CH_DE_AUCT_train$auction_price_ch_de)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_DE_CH)*sd(df_DE_CH_AUCT_train$auction_price_de_ch) + mean(df_DE_CH_AUCT_train$auction_price_de_ch)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2) 
          
          
          current_params_DA_CH <- list(MSE= mse_DA_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_DA_DE <- list(MSE= mse_DA_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_CH_DE <- list(MSE= mse_AUCT_CH_DE, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
          current_params_AUCT_DE_CH <- list(MSE= mse_AUCT_DE_CH, q_arma = q_arma, p_arma = p_arma, q_garch=q_garch, p_garch=p_garch)
  
          if (results_mat$Swiss_DA_Price[1] > mse_DA_CH){
            results_mat$Swiss_DA_Price= current_params_DA_CH}
  
          if (results_mat$German_DA_Price[1] > mse_DA_DE){
            results_mat$German_DA_Price= current_params_DA_DE}
          
          if (results_mat$CH_DE_AUCT_Price[1] > mse_AUCT_CH_DE){
            results_mat$CH_DE_AUCT_Price= current_params_AUCT_CH_DE}
          
          if (results_mat$DE_CH_AUCT_Price[1] > mse_AUCT_DE_CH){
            results_mat$DE_CH_AUCT_Price= current_params_AUCT_DE_CH}
          
        }, error = function(e) {
          cat("An error occurred:", conditionMessage(e), "\n")

        })
      }
    }
  }
}


```





```{r}
          garch_model_Swiss_DA <- ugarchspec(mean.model = list(armaOrder = c(results_mat$Swiss_DA_Price$q_arma,results_mat$Swiss_DA_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$Swiss_DA_Price$q_garch, results_mat$Swiss_DA_Price$p_garch)), 
                                    distribution.model = "norm")  
          garch_model_German_DA <- ugarchspec(mean.model = list(armaOrder = c(results_mat$German_DA_Price$q_arma,results_mat$German_DA_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$German_DA_Price$q_garch, results_mat$German_DA_Price$p_garch)), 
                                    distribution.model = "norm") 
          garch_model_Auct_CH_DE <- ugarchspec(mean.model = list(armaOrder = c(results_mat$CH_DE_AUCT_Price$q_arma,results_mat$CH_DE_AUCT_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$CH_DE_AUCT_Price$q_garch, results_mat$CH_DE_AUCT_Price$p_garch)), 
                                    distribution.model = "norm") 
          garch_model_AUCT_DE_CH <- ugarchspec(mean.model = list(armaOrder = c(results_mat$DE_CH_AUCT_Price$q_arma,results_mat$DE_CH_AUCT_Price$p_arma)), 
                                    variance.model = list(model = "sGARCH",
                                    garchOrder = c(results_mat$DE_CH_AUCT_Price$q_garch, results_mat$DE_CH_AUCT_Price$p_garch)), 
                                    distribution.model = "norm") 


          fit_DA_price_ch_optim_paras_ARAM_1_1 <- ugarchfit(garch_model_Swiss_DA, data = df_CH_DA_train_GARCH, formula = formula_DA_price_ch)
          fit_DA_price_de_optim_paras_ARAM_1_1 <- ugarchfit(garch_model_German_DA, data = df_DE_DA_train_GARCH, formula = formula_DA_price_de)
          fit_auction_CH_DE_optim_paras_ARAM_1_1  <- ugarchfit(garch_model_Auct_CH_DE, data = df_CH_DE_AUCT_train_GARCH, formula = formula_auction_CH_DE)
          fit_auction_DE_CH_optim_paras_ARAM_1_1  <- ugarchfit(garch_model_AUCT_DE_CH, data = df_DE_CH_AUCT_train_GARCH, formula = formula_auction_DE_CH)
          
          fitted_values_DA_CH= fitted(fit_DA_price_ch_optim_paras_ARAM_1_1)
          fitted_values_DA_DE= fitted(fit_DA_price_de_optim_paras_ARAM_1_1)
          fitted_values_AUCT_DE_CH= fitted(fit_auction_CH_DE_optim_paras_ARAM_1_1)
          fitted_values_AUCT_CH_DE= fitted(fit_auction_DE_CH_optim_paras_ARAM_1_1)
          
          mse_DA_CH= mean((df_CH_DA_train$day_ahead_price_ch -fitted_values_DA_CH)^2) 
          mse_DA_DE= mean((df_DE_DA_train$day_ahead_price_de -fitted_values_DA_DE)^2) 
          mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_train$auction_price_ch_de -fitted_values_AUCT_CH_DE)^2)
          mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_train$auction_price_de_ch-fitted_values_AUCT_DE_CH)^2)
          

          
```



```{r}

#Visualization of fit:
# Extract the fitted values
fitted_values_DA_CH <- fitted(fit_DA_price_ch_optim_paras_ARAM_1_1)
fitted_values_DA_DE <- fitted(fit_DA_price_de_optim_paras_ARAM_1_1)
fitted_values_AUCT_CH_DE <- fitted(fit_auction_CH_DE_optim_paras_ARAM_1_1)
fitted_values_AUCT_DE_CH <- fitted(fit_auction_DE_CH_optim_paras_ARAM_1_1)

# Combine the original and fitted values into data frames
df_fitted_DA_CH <- data.frame(Time = 1:nrow(df_CH_DA_train_GARCH), Original = df_CH_DA_train$day_ahead_price_ch, Fitted = fitted_values_DA_CH)
df_fitted_DA_DE <- data.frame(Time = 1:nrow(df_DE_DA_train_GARCH), Original = df_DE_DA_train$day_ahead_price_de, Fitted = fitted_values_DA_DE)
df_fitted_AUCT_CH_DE <- data.frame(Time = 1:nrow(df_CH_DE_AUCT_train_GARCH), Original = df_CH_DE_AUCT_train$auction_price_ch_de, Fitted = fitted_values_AUCT_CH_DE)
df_fitted_AUCT_DE_CH <- data.frame(Time = 1:nrow(df_DE_CH_AUCT_train_GARCH), Original = df_DE_CH_AUCT_train$auction_price_de_ch, Fitted = fitted_values_AUCT_DE_CH)

# Plot the original and fitted values using base R
plot_fitted_base <- function(df, title) {
  plot(df$Time, df$Original, type = "l", col = "black", lwd = 2, ylab = "Value", xlab = "Time", main = title)
  lines(df$Time, df$Fitted, col = "red", lwd = 2)
  legend("topright", legend = c("Original", "Fitted"), col = c("black", "red"), lwd = 2)
}

# Plot each dataset
par(mfrow = c(1,1))  # Set up a 2x2 plotting space
plot_fitted_base(df_fitted_DA_CH, "Day Ahead Price CH")
plot_fitted_base(df_fitted_DA_DE, "Day Ahead Price DE")
plot_fitted_base(df_fitted_AUCT_CH_DE, "Auction Price CH-DE")
plot_fitted_base(df_fitted_AUCT_DE_CH, "Auction Price DE-CH")


```

```{r}
# Save the models to a file
save(results_mat, fit_DA_price_ch_optim_paras_ARAM_1_1, fit_DA_price_de_optim_paras_ARAM_1_1, fit_auction_CH_DE_optim_paras_ARAM_1_1, fit_auction_DE_CH_optim_paras_ARAM_1_1, file = "garch_models_ARMA_1_1_GARCH_25_25.RData")

# Optionally, print a message to confirm saving
cat("Models have been saved \n")
```





```{r}
          predicted_values_DA_CH <- fitted(ugarchforecast(fit_DA_price_ch_optim_paras_ARAM_1_1, n.ahead = 743, external.forecasts = list(mregfor = df_CH_DA_test)))
          predicted_values_DA_DE <- fitted(ugarchforecast(fit_DA_price_de_optim_paras_ARAM_1_1, n.ahead = 743,external.forecasts = list(mregfor = df_DE_DA_test)))
          predicted_values_AUCT_DE_CH <- fitted(ugarchforecast(fit_auction_CH_DE_optim_paras_ARAM_1_1, n.ahead = 743, external.forecasts = list(mregfor = df_DE_CH_AUCT_test)))
          predicted_values_AUCT_CH_DE <- fitted(ugarchforecast(fit_auction_DE_CH_optim_paras_ARAM_1_1,external.forecasts = list(mregfor = df_CH_DE_AUCT_test)))

          
#print("Swiss DA Prices:")
R2_DA_CH= calculate_r_squared(df_CH_DA_test$day_ahead_price_ch[1:743],predicted_values_DA_CH)
mse_DA_CH= mean((df_CH_DA_test$day_ahead_price_ch[1:743] -predicted_values_DA_CH)^2)

#print("German DA Prices:")
R2_DA_DE= calculate_r_squared(df_DE_DA_test$day_ahead_price_de[1:743], predicted_values_DA_DE)
mse_DA_DE= mean((df_DE_DA_test$day_ahead_price_de[1:743] - predicted_values_DA_DE)^2)

#print("Auction Prices: CH-DE")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_DE_CH= calculate_r_squared(df_DE_CH_AUCT_test$auction_price_de_ch[1:743], pmax(0,predicted_values_AUCT_DE_CH))
mse_AUCT_DE_CH= mean((df_DE_CH_AUCT_test$auction_price_de_ch[1:743] -pmax(0,predicted_values_AUCT_CH_DE))^2)


#print("Auction Prices: DE-CH")
#Taking pmax of auction price prediction due to auction prices never being negative

R2_AUCT_CH_DE= calculate_r_squared(df_CH_DE_AUCT_test$auction_price_ch_de[1:743], pmax(0,predicted_values_AUCT_CH_DE))
mse_AUCT_CH_DE= mean((df_CH_DE_AUCT_test$auction_price_ch_de[1:743] -pmax(0,predicted_values_AUCT_CH_DE))^2)


# Create a dataframe for Sample 1
Day_Ahead_Price_CH <- data.frame(mse = mse_DA_CH, rsquared = R2_DA_CH, row.names = "Swiss DA Prices")

# Create a dataframe for Sample 2
Day_Ahead_Price_DE <- data.frame(mse = mse_DA_DE, rsquared = R2_DA_DE, row.names = "German DA Prices")


Auction_Price_CH_DE <- data.frame(mse = mse_AUCT_CH_DE, rsquared = R2_AUCT_CH_DE, row.names = "Auction Price CH_DE")

Auction_Price_DE_CH <- data.frame(mse = mse_AUCT_DE_CH, rsquared = R2_AUCT_DE_CH, row.names = "Auction Price DE_CH")


# Bind the dataframes row-wise
result_table <- rbind(Day_Ahead_Price_CH, Day_Ahead_Price_DE,Auction_Price_CH_DE, Auction_Price_DE_CH )

# Print the result
print(result_table)
          
         
```


```{r}
#Visualization of out of sample fit:
plot(df_CH_DA_test$day_ahead_price_ch[0:743], type="l", main="Swiss Day Ahead Prices - Predictions",  xlab = " ", ylab = "Price", xaxt = "n", ylim=c(0,350))
lines(predicted_values_DA_CH, col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_DA_test$day_ahead_price_de[0:743], type="l", main="fit_DA_DE", ylim=c(-50,350), xlab = " ", ylab = "Price", xaxt = "n")
lines(predicted_values_DA_DE, col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

plot(df_DE_CH_AUCT_test$auction_price_de_ch[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,80))
lines(pmax(0,predicted_values_AUCT_DE_CH), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)


plot(df_CH_DE_AUCT_test$auction_price_ch_de[0:743], type="l", main="fit_AC_DE_CH", xlab = " ", ylab = "Price", xaxt = "n", ylim= c(0,25))
lines(pmax(0,predicted_values_AUCT_CH_DE), col="red")
axis(1, at = seq(1, 743, by = 360), labels = df_DE_DA_test$date[seq(1, 743, by = 360)], las = 2, cex.axis = 0.7)

```







##Part Three ##: Two Step Model

In the next approach, we are going to take the residuals from our first fit and
see if we can run a GARCH model on them. Our final prediction in this approach 
will be the sum of the prediction of the linear model and the prediction of the 
residual from the GARCH model


First we need to calculate the residuals: 
```{r}

# Calculate residuals

residuals_DA_CH= df_CH_DA_train$day_ahead_price_ch - fit_DA_CH$fitted.values
residuals_DA_DE=df_DE_DA_train$day_ahead_price_de - fit_DA_DE$fitted.values
residuals_AC_CH_DE=df_CH_DE_AUCT_train$auction_price_ch_de  - fit_AC_CH_DE$fitted.values
residuals_AC_DE_CH=df_DE_CH_AUCT_train$auction_price_de_ch - fit_AC_DE_CH$fitted.values


  
```



Now we will run a GARCH model on the residuals for each different response 
variable

1. SWISS DAY AHEAD PRICES
```{r}
#making data stationary
residuals=residuals_DA_CH

q_value=seq(1,5,by=1)
p_values=seq(1,5,by=1)
results_mat= matrix(NA,length(q_value), length(p_values))
for (q in q_value){
  for (p in p_values){
    stationary_data <- tanh(residuals)
    
    
    garch_model <- ugarchspec(mean.model = list(armaOrder = c(0,0)), 
                              variance.model = list(model = "sGARCH",
                              garchOrder = c(q, p)), 
                              distribution.model = "norm")
    fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
    fitted_values= fitted(fit_garch)
    length(fitted_values)
    
    mse=mean((stationary_data -fitted_values)^2)
    
    cat("with q = ", q, " and p = ", p, " --> MSE: ", mse, "\n")
    results_mat[q,p]= mse
    
  }
}

min(results_mat)
min_index <- which(results_mat == min(results_mat), arr.ind = TRUE)
min_index


```
As we see, the best parameters for the models are q=1 and p=5

```{r}

garch_model <- ugarchspec(mean.model = list(armaOrder = c(0,0)), 
                          variance.model = list(model = "sGARCH",
                              garchOrder = c(1, 5)), 
                          distribution.model = "norm")
fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
stationary_predictions= fitted(fit_garch)


original_predictions=atanh(stationary_predictions)

plot(original_predictions, type="l")

fit_garch_DA_CH= fit_garch
predictions_garch_DA_CH_training= original_predictions


forecast_garch <- ugarchforecast(fit_garch, n.ahead = nrow(df_CH_DA_test))

forecast_values <- as.numeric(fitted(forecast_garch))

predictions_garch_DA_CH_test <- atanh(forecast_values)
 

```

In a next step we are going to see if we were able to increase the performance 
of the linear model if we combine it with the GARCH model:

```{r}

#Checking if GARCH improved model performance
fit= fit_DA_CH
garch_predictions= predictions_garch_DA_CH_test
actual_y_values= test_df$day_ahead_price_ch



Mixed_Model_predicitons=predict(object = fit, newdata=test_df)+garch_predictions

R2_lin= calculate_r_squared(actual_y_values, predict(object = fit, newdata=test_df))
R2_mixed= calculate_r_squared(actual_y_values, Mixed_Model_predicitons)
print("Including GARCH changed the R2 by:")
print(R2_mixed-R2_lin)

mse_lin= mean((actual_y_values -predict(object = fit, newdata=test_df))^2)
mse_mixed= mean((actual_y_values -Mixed_Model_predicitons)^2)
print("Including GARCH changed the MSE by:")
print(mse_mixed-mse_lin)
```
As the R2 metric has improved slightly, and the MSE has 
decreased quite a lot, we can conclude that the mixed model is significantly 
better at modelling the Swiss Day ahead prices

2. GERMAN DAY AHEAD PRICES
```{r}
#making data stationary
residuals=residuals_DA_DE

q_value=c(0) #Model often failed to converge if q was not eaual to 0
p_values=c(0,1,2,3,4,5)
results_mat= matrix(NA,length(q_value), length(p_values))
for (q in q_value){
  for (p in p_values){
    if (q!=1 | p!=1){
      
      stationary_data <- tanh(residuals)
      
      
      garch_model <- ugarchspec(mean.model = list(armaOrder = c(0, 0)), 
                                variance.model = list(model = "sGARCH", 
                                                      garchOrder = c(q, p)), 
                                distribution.model = "norm")
      fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
      fitted_values= fitted(fit_garch)
      length(fitted_values)
      
      mse=mean((stationary_data -fitted_values)^2)
      
      cat("with q = ", q, " and p = ", p, " --> MSE: ", mse, "\n")
      results_mat[q+1,p+1]= mse
    }
  }
}

min(results_mat)
min_index <- which(results_mat == min(results_mat), arr.ind = TRUE)
min_index


```


As we see, the best parameters for the models are q= and p=

```{r}

garch_model <- ugarchspec(mean.model = list(armaOrder = c(0, 5)), 
                          variance.model = list(model = "sGARCH", 
                                                garchOrder = c(1, 5)), 
                          distribution.model = "norm")
fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
stationary_predictions= fitted(fit_garch)


original_predictions=atanh(stationary_predictions)

plot(original_predictions, type="l")

fit_garch_DA_DE= fit_garch
predictions_garch_DA_DE_training= original_predictions


forecast_garch <- ugarchforecast(fit_garch, n.ahead = nrow(df_DE_DA_test))

forecast_values <- as.numeric(fitted(forecast_garch))

predictions_garch_DA_DE_test <- atanh(forecast_values)

```

Evaluating the prformance of the mixed model
```{r}


#Checking if GARCH improved model performance
fit= fit_DA_DE
garch_predictions= predictions_garch_DA_DE_test
actual_y_values= test_df$day_ahead_price_de



Mixed_Model_predicitons=predict(fit, newdata=test_df)+garch_predictions

R2_lin= calculate_r_squared(actual_y_values, predict(fit, newdata=test_df))
R2_mixed= calculate_r_squared(actual_y_values, Mixed_Model_predicitons)
print("Including GARCH changed the R2 by:")
print(R2_mixed-R2_lin)

mse_lin= mean((actual_y_values -predict(fit, newdata=test_df))^2)
mse_mixed= mean((actual_y_values -Mixed_Model_predicitons)^2)
print("Including GARCH changed the MSE by:")
print(mse_mixed-mse_lin)
```
Also for the german day ahead prices the mixed models seems to performe quite a 
bit better


3. AUCTION PRICES CH - DE
```{r}
#making data stationary
residuals=residuals_AC_CH_DE

q_value=c(0,1,2,3,4,5) #Model often failed to converge if q was not eaual to 0
p_values=c(0,1,2,3,4,5)
results_mat= matrix(NA,length(q_value), length(p_values))
for (q in q_value){
  for (p in p_values){
    if (q!=1 | p!=1){
      
      stationary_data <- tanh(residuals)
      
      
      garch_model <- ugarchspec(mean.model = list(armaOrder = c(0, 0)), 
                                variance.model = list(model = "sGARCH", 
                                                      garchOrder = c(q, p)), 
                                distribution.model = "norm")
      fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
      fitted_values= fitted(fit_garch)
      length(fitted_values)
      
      mse=mean((stationary_data -fitted_values)^2)
      
      cat("with q = ", q, " and p = ", p, " --> MSE: ", mse, "\n")
      results_mat[q+1,p+1]= mse
    }
  }
}

min(results_mat, na.rm = TRUE)
min_index <- which(results_mat == min(results_mat), arr.ind = TRUE)
min_index


```


As we see, the best parameters for the models are q=1 and p=4

```{r}

garch_model <- ugarchspec(mean.model = list(armaOrder = c(1, 4)), 
                          variance.model = list(model = "sGARCH"), 
                          distribution.model = "norm")
fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
stationary_predictions= fitted(fit_garch)


original_predictions=atanh(stationary_predictions)

plot(original_predictions, type="l")

fit_garch_AC_CH_DE= fit_garch
predictions_garch_AC_CH_DE_train= original_predictions


forecast_garch <- ugarchforecast(fit_garch, n.ahead = nrow(df_CH_DE_AUCT_test))

forecast_values <- as.numeric(fitted(forecast_garch))

predictions_garch_AC_CH_DE_test <- atanh(forecast_values) 

```



```{r}


#Checking if GARCH improved model performance
fit= fit_AC_CH_DE
garch_predictions= predictions_garch_AC_CH_DE_test
actual_y_values= test_df$auction_price_ch_de



Mixed_Model_predicitons=predict(fit, newdata=test_df) + garch_predictions

R2_lin= calculate_r_squared(actual_y_values, predict(fit, newdata=test_df))
R2_mixed= calculate_r_squared(actual_y_values, Mixed_Model_predicitons)
print("Including GARCH changed the R2 by:")
print(R2_mixed-R2_lin)

mse_lin= mean((actual_y_values -predict(fit, newdata=test_df))^2)
mse_mixed= mean((actual_y_values -Mixed_Model_predicitons)^2)
print("Including GARCH changed the MSE by:")
print(mse_mixed-mse_lin)
```
The model actually performed worse for the auction price modelling (decreasing R2 and increasing the MSE)



4. AUCTION PRICES DE-CH
```{r}
#making data stationary
residuals=residuals_AC_DE_CH

q_value=c(0,1,2,3,4,5) #Model often failed to converge if q was not eaual to 0
p_values=c(0,1,2,3,4,5)
results_mat= matrix(NA,length(q_value), length(p_values))
for (q in q_value){
  for (p in p_values){
    if (q!=1 | p!=1){
      
      stationary_data <- tanh(residuals)
      
      
      garch_model <- ugarchspec(mean.model = list(armaOrder = c(q, p)), 
                                variance.model = list(model = "sGARCH"), 
                                distribution.model = "norm")
      fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
      fitted_values= fitted(fit_garch)
      length(fitted_values)
      
      mse=mean((stationary_data -fitted_values)^2)
      
      cat("with q = ", q, " and p = ", p, " --> MSE: ", mse, "\n")
      results_mat[q+1,p+1]= mse
    }
  }
}

min(results_mat)
min_index <- which(results_mat == min(results_mat), arr.ind = TRUE)
min_index


```

As we see, the best parameters for the models are q=2 and p=1

```{r}

garch_model <- ugarchspec(mean.model = list(armaOrder = c(2, 1)), 
                          variance.model = list(model = "sGARCH", 
                                                garchOrder = c(1, 5)), 
                          distribution.model = "norm")
fit_garch <- ugarchfit(spec = garch_model, data = stationary_data)
stationary_predictions= fitted(fit_garch)


original_predictions=atanh(stationary_predictions)

plot(original_predictions, type="l")

fit_garch_AC_CH_DE= fit_garch
predictions_garch_AC_DE_CH_train= original_predictions

forecast_garch <- ugarchforecast(fit_garch, n.ahead = nrow(test_df))

forecast_values <- as.numeric(fitted(forecast_garch))

predictions_garch_AC_DE_CH_test <- atanh(forecast_values)

```

```{r}

#Checking if GARCH improved model performance
fit= fit_AC_DE_CH
garch_predictions= predictions_garch_AC_DE_CH_test
actual_y_values= test_df$auction_price_de_ch



Mixed_Model_predicitons=predict(fit, newdata = test_df)+garch_predictions

R2_lin= calculate_r_squared(actual_y_values, predict(fit, newdata = test_df))
R2_mixed= calculate_r_squared(actual_y_values, Mixed_Model_predicitons)
print("Including GARCH changed the R2 by:")
print(R2_mixed-R2_lin)

mse_lin= mean((actual_y_values -predict(fit, newdata = test_df))^2)
mse_mixed= mean((actual_y_values -Mixed_Model_predicitons)^2)
print("Including GARCH changed the MSE by:")
print(mse_mixed-mse_lin)
```
For the german day ahead prices, the mixed model again seems to increase performance quite a lot especially in terms of MSE



#Conclusion Mixed Models#

The mixed model, applying a GARCH model to the residuals of the linear model, seems to perform better than the linar model alone. The only exception is the modelling of the Auction Prices from Switzerland to Germany, however, this model is very badly approximated by either, the linear and the mixed model.



###### Generalized least squares using the correlation matrix

```{r}
#GEtting rid of suplicated columns
# Assuming 'data' is your data frame with potentially duplicate columns
# Transpose the data frame to check for duplicated columns
data_transposed <- t(df)

# Use duplicated() function to identify duplicate columns
duplicated_cols <- duplicated(data_transposed)

# Subset the transposed data frame to remove duplicate columns
data_transposed_no_duplicates <- data_transposed[!duplicated_cols, ]

# Transpose the data frame back to its original shape
df_no_duplicates <- t(data_transposed_no_duplicates)

selected_cols <- colnames(df_no_duplicates)

df_no_duplicates <- df[, selected_cols]

```



```{r}
# Assuming you have your returns data in a vector or a dataframe
# Replace 'returns_data' with your actual data
returns <- df_no_duplicates$day_ahead_price_ch


# Load required libraries
library(rugarch)
library(nlme)

# Estimate GARCH model
garch_spec <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)), 
                         mean.model = list(armaOrder = c(0, 0), include.mean = FALSE))
garch_fit <- ugarchfit(spec = garch_spec, data = returns)

# Extract conditional covariance matrix
cov_matrix <- sigma(garch_fit)


# Assuming you have your GLS data in a dataframe 'gls_data'
# Replace 'dependent_variable' with your dependent variable name
# Replace 'independent_variable1', 'independent_variable2', ..., 'correlated_variable' 
# with your actual variable names
gls_data <- df_no_duplicates[,1:100] # I get a singular Matrix error when i include all 114 predictors... why???


# Create correlation structure
correlation_structure <- corCompSymm(form = ~ 1 | returns)





# Create GLS model with predictor variables and correlation matrix
gls_model <- gls(day_ahead_price_ch ~ ., 
                 data = gls_data, correlation = correlation_structure)

# Fit the model
gls_results <- summary(gls_model)

# Print summary
print(gls_results)

```
```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```
