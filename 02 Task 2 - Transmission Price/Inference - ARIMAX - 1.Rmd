---
title: "ARIMAX"
author: "Federico Deotto"
date: "2024-03-12"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggsci)
library(scales)


setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Default theme for charts
theme_set(
  theme_bw() +
    theme(  
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(
        face = "italic", size = 10, colour = "green50"
      )
    )
)

```

## The Goal

Select variables based on availability (NA) and variance, ensuring conversion to the appropriate type (e.g., converting integers into numeric data).

```{r}
# Read data - both direction JAO
df <- read_csv("../00 Data Retrieval and Cleaning/0_df_final_imputed.csv")

df$date %>% str()
```

Convert dummies for missing values and variable dst into factor, and ensure that all numeric colums are encoded as such.

```{r}
df <- df %>%
  mutate_at(vars(-date), as.numeric)

dummies_columns <- df %>%
  select(contains("_missing_dummy")) %>% 
  colnames()

factor_colums <- c('dst', dummies_columns)

df <- df %>%
  mutate_at(vars(factor_colums), factor)
```


# Cutting of time series 

The timestamps are selected arbitrarily. The guiding idea behind the choice was to roughly recover some stationarity conditions in the log-transformed price.
```{r}
first_cut <- as.POSIXct("2021-06-30 23:00:00", tz = "UTC")
second_cut <- as.POSIXct("2022-12-31 23:00:00", tz = "UTC")
```

Create a data.frame that contains exclusively the log_transfo of the four prices and their timestamp (date).
```{r}
prices_name <- c('day_ahead_price_de', 
                 'day_ahead_price_ch',
                 'auction_price_ch_de',
                 'auction_price_de_ch')
df_box <- df %>% 
  select(c('date', prices_name))

#log_transform <- function(x) {
#  log_shifted <- log(x - min(x) + 1)  # Shift all values to ensure positivity
#  return(log_shifted)
#}

boxcox_transform <- function(x, lambda) {
  y = x - min(x) + 1
  if (lambda == 0) {
    log(y)
  } else {
    (y^lambda - 1) / lambda
  }
}


df_box <- df_box %>%
  mutate_at(vars(all_of(prices_name)), ~ boxcox_transform(., lambda = 0))
```


```{r}
# Make the chart
df_box %>% 
  filter(date < first_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = day_ahead_price_de, color = "day_ahead_price_de")) +
  geom_line(aes(y = day_ahead_price_ch, color = "day_ahead_price_ch")) +
  labs(title = "Prices First Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("day_ahead_price_de" = "green", "day_ahead_price_ch" = "red"))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```


```{r}
# Make the chart
df_box %>% 
  filter(date < second_cut & date >= first_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = day_ahead_price_de, color = "day_ahead_price_de")) +
  geom_line(aes(y = day_ahead_price_ch, color = "day_ahead_price_ch")) +
  labs(title = "Prices Second Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("day_ahead_price_de" = "green", "day_ahead_price_ch" = "red"))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```


```{r}
# Make the chart
df_box %>% 
  filter(date > second_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = day_ahead_price_de, color = "day_ahead_price_de")) +
  geom_line(aes(y = day_ahead_price_ch, color = "day_ahead_price_ch")) +
  labs(title = "Prices Third Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("day_ahead_price_de" = "green", "day_ahead_price_ch" = "red"))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```


We can see that the log_transfo is not good with the auction_prices. Try another boxCox transfo in order to take care of skewness. The interpretability of the final modell will be compromise, since the log transfo guarantees an interpretation of the coef in terms of percentage change.

```{r}
# Make the chart
df_box %>% 
  filter(date < first_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = auction_price_ch_de, color = "auction_price_ch_de")) +
  geom_line(aes(y = auction_price_de_ch, color = "auction_price_de_ch")) +
  labs(title = "Prices Second Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("auction_price_de_ch" = "orange", "auction_price_ch_de" = "blue" ))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```

```{r}
auction_price <- prices_name[3:4]
df_box[, auction_price] <- df[, auction_price]

df_box <- df_box %>%
  mutate_at(vars(all_of(auction_price)), ~ boxcox_transform(., lambda = -0.001))
```



```{r}
# Make the chart
df_box %>% 
  filter(date < first_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = auction_price_ch_de, color = "auction_price_ch_de")) +
  geom_line(aes(y = auction_price_de_ch, color = "auction_price_de_ch")) +
  labs(title = "Prices Second Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("auction_price_de_ch" = "orange", "auction_price_ch_de" = "blue" ))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```


# PRICE ELECTRICITY GERMANY

In this section we focus in the analysis of the german elcetricity price.

```{r}
# Make the chart
df_box %>% 
  filter(date < first_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = day_ahead_price_de, color = "day_ahead_price_de")) +
  scale_x_datetime(date_labels = "%Y-%m", date_breaks="4 months") +
  labs(title = "Prices First Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("day_ahead_price_de" = "green"))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```


```{r}
# Make the chart
df_box %>% 
  filter(date < second_cut & date >= first_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = day_ahead_price_de, color = "day_ahead_price_de")) +
  scale_x_datetime(date_labels = "%Y-%m", date_breaks="4 months") +
  labs(title = "Prices Second Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("day_ahead_price_de" = "green"))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```


```{r}
# Make the chart
df_box %>% 
  filter(date > second_cut) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = day_ahead_price_de, color = "day_ahead_price_de")) +
  scale_x_datetime(date_labels = "%Y-%m", date_breaks="4 months") +
  labs(title = "Prices Third Period",
       x = "Hourly data",
       y = "Price day ahead",
       color = "Day ahead prices") +
  scale_color_manual(values = c("day_ahead_price_de" = "green"))+
  theme(plot.margin = margin(10, 10, 10, 10), legend.position = "bottom")
```



```{r}
date_outlier <- df_box %>%
  filter(day_ahead_price_de == min(day_ahead_price_de)) %>% 
  pull(date)
```


```{r}

```











